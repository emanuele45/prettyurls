<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>el:prettyurls</id>
	<version>0.9</version>

	<file name="$boarddir/index.php">
		<operation>
			<search position="replace"><![CDATA[
// Clean the request variables, add slashes, etc.
cleanRequest();
$context = array();
]]></search>
			<add><![CDATA[
// Unserialize the array of pretty board URLs
$context = array('pretty' => array(
	'action_array' => unserialize($modSettings['pretty_action_array']),
	'board_urls' => unserialize($modSettings['pretty_board_urls']),
	'db_count' => 0,
));
// Clean the request variables, add slashes, etc.
cleanRequest();
]]></add>
		</operation>
	</file>

	<file name="$boarddir/SSI.php">
		<operation>
			<search position="replace"><![CDATA[
// Clean the request variables.
]]></search>
			<add><![CDATA[
// Unserialize the array of pretty board URLs
$context = array('pretty' => array(
	'action_array' => unserialize($modSettings['pretty_action_array']),
	'board_urls' => unserialize($modSettings['pretty_board_urls']),
	'db_count' => 0,
));
// Clean the request variables.
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Admin.php">
		<operation>
			<search position="before"><![CDATA[
				'theme' => array(
					'label' => $txt['theme_admin'],
					'file' => 'Themes.php',
					'function' => 'ThemesMain',
					'custom_url' => $scripturl . '?action=admin;area=theme;sa=admin',
					'icon' => 'themes.gif',
					'subsections' => array(
						'admin' => array($txt['themeadmin_admin_title']),
						'list' => array($txt['themeadmin_list_title']),
						'reset' => array($txt['themeadmin_reset_title']),
						'edit' => array($txt['themeadmin_edit_title']),
					),
				),
]]></search>
			<add><![CDATA[
				'pretty' => array(
					'label' => $txt['pretty_admin_menu'],
					'file' => 'PrettyUrls.php',
					'function' => 'PrettyInterface',
					'custom_url' => $scripturl . '?action=admin;area=pretty',
				),
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageErrors.php">
		<operation>
			<search position="replace"><![CDATA[
	$context['sub_template'] = 'error_log';
]]></search>
			<add><![CDATA[
	$context['sub_template'] = 'error_log';

	//	Don't rewrite any URLs, we need these ones to remain exact!
	$modSettings['pretty_enable_filters'] = false;
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageSettings.php">
		<operation>
			<search position="replace"><![CDATA[
			array('check', 'queryless_urls'),
]]></search>
			<add><![CDATA[
			//	Pretty URLs mod - disable the default queryless URLs
			//	array('check', 'queryless_urls'),
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/News.php">
		<operation>
			<search position="replace"><![CDATA[
	if ($xml_format == 'smf' || isset($_REQUEST['debug']))
]]></search>
			<add><![CDATA[
	//	Pretty URLs need to be rewritten
	ob_start('ob_sessrewrite');
	$context['pretty']['search_patterns'][] = '~(<link>|<id>|<comments>|<guid>)([^#<]+)~';
	$context['pretty']['replace_patterns'][] = '~(<link>|<id>|<comments>|<guid>)([^<]+)~';

	if ($xml_format == 'smf' || isset($_REQUEST['debug']))
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/QueryString.php">
		<operation>
			<search position="replace"><![CDATA[
function ob_sessrewrite($buffer)
{
	global $scripturl, $modSettings, $user_info, $context;
]]></search>
			<add><![CDATA[
function ob_sessrewrite($buffer)
{
	global $scripturl, $modSettings, $user_info, $context, $db_count, $sourcedir, $time_start, $txt;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	// This should work even in 4.2.x, just not CGI without cgi.fix_pathinfo.
	if (!empty($modSettings['queryless_urls']) && (!$context['server']['is_cgi'] || @ini_get('cgi.fix_pathinfo') == 1) && $context['server']['is_apache'])
	{
		// Let's do something special for session ids!
		if (defined('SID') && SID != '')
			$buffer = preg_replace('/"' . preg_quote($scripturl, '/') . '\?(?:' . SID . ';)((?:board|topic)=[^#"]+?)(#[^"]*?)?"/e', "'\"' . \$scripturl . '/' . strtr('\$1', '&;=', '//,') . '.html?' . SID . '\$2\"'", $buffer);
		else
			$buffer = preg_replace('/"' . preg_quote($scripturl, '/') . '\?((?:board|topic)=[^#"]+?)(#[^"]*?)?"/e', "'\"' . \$scripturl . '/' . strtr('\$1', '&;=', '//,') . '.html\$2\"'", $buffer);
	}
]]></search>
			<add><![CDATA[
	//	Rewrite the buffer with Pretty URLs!
	if ($modSettings['pretty_enable_filters'])
	{
		require_once($sourcedir . '/PrettyUrls-Filters.php');
		$buffer = pretty_rewrite_buffer($buffer);
	}

	//	Update the load times
	$pattern = '~<span class="smalltext">' . $txt['page_created'] . '([.0-9]+)' . $txt['seconds_with'] . '([0-9]+)' . $txt['queries'] . '</span>~';
	if (preg_match($pattern, $buffer, $matches))
	{
		$newTime = round(array_sum(explode(' ', microtime())) - array_sum(explode(' ', $time_start)), 3);
		$timeDiff = $newTime - (float) $matches[1];
		$queriesDiff = $db_count + $context['pretty']['db_count'] - (int) $matches[2];
		//	Remove the link if you like, I won't enforce it like others do
		$newLoadTime = '<span class="smalltext">' . $txt['page_created'] . $newTime . $txt['seconds_with'] . $db_count . $txt['queries'] . ' (<a href="http://code.google.com/p/prettyurls/">Pretty URLs</a> adds ' . $timeDiff . 's, ' . $queriesDiff . 'q)</span>';
		$buffer = str_replace($matches[0], $newLoadTime, $buffer);
	}
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs.php">
		<operation>
			<search position="replace"><![CDATA[
function redirectexit($setLocation = '', $refresh = false)
{
	global $scripturl, $context, $modSettings, $db_show_debug, $db_cache;
]]></search>
			<add><![CDATA[
function redirectexit($setLocation = '', $refresh = false, $permanent = false)
{
	global $scripturl, $context, $modSettings, $db_show_debug, $db_cache, $sourcedir;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	if (!empty($modSettings['queryless_urls']) && (empty($context['server']['is_cgi']) || @ini_get('cgi.fix_pathinfo') == 1) && !empty($context['server']['is_apache']))
	{
		if (defined('SID') && SID != '')
			$setLocation = preg_replace('/^' . preg_quote($scripturl, '/') . '\?(?:' . SID . ';)((?:board|topic)=[^#]+?)(#[^"]*?)?$/e', "\$scripturl . '/' . strtr('\$1', '&;=', '//,') . '.html\$2?' . SID", $setLocation);
		else
			$setLocation = preg_replace('/^' . preg_quote($scripturl, '/') . '\?((?:board|topic)=[^#"]+?)(#[^"]*?)?$/e', "\$scripturl . '/' . strtr('\$1', '&;=', '//,') . '.html\$2'", $setLocation);
	}

	if (isset($modSettings['integrate_redirect']) && function_exists($modSettings['integrate_redirect']))
		$modSettings['integrate_redirect']($setLocation, $refresh);
]]></search>
			<add><![CDATA[
	//	Redirections should be pretty too
	if ($modSettings['pretty_enable_filters'])
	{
		require_once($sourcedir . '/PrettyUrls-Filters.php');
		$url = array(0 => array('url' => $setLocation, 'url_id' => 'setLocation'));
		$filter_callbacks = unserialize($modSettings['pretty_filter_callbacks']);
		foreach ($filter_callbacks as $callback)
		{
			$pretty_url = call_user_func($callback, $url);
			if (isset($pretty_url[0]['replacement']))
				break;
		}
		if (isset($pretty_url[0]['replacement']))
			$setLocation = $pretty_url[0]['replacement'];
		$setLocation = str_replace("\x12", '\'', $setLocation);
		$setLocation = preg_replace(array('~;+|=;~', '~\?;~', '~\?#|;#|=#~', '~\?$|;$|#$|=$~'), array(';', '?', '#', ''), $setLocation);
	}

	if (isset($modSettings['integrate_redirect']) && function_exists($modSettings['integrate_redirect']))
		$modSettings['integrate_redirect']($setLocation, $refresh);

	if ($permanent)
		header('HTTP/1.1 301 Moved Permanently');
]]></add>
		</operation>
	</file>

</modification>
