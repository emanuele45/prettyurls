<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>el:prettyurls-ext-none</id>
	<version>0.4</version>

	<file name="$sourcedir/BoardIndex.php">
		<operation>
			<search position="replace"><![CDATA[
function BoardIndex()
{
	global $txt, $scripturl, $db_prefix, $ID_MEMBER, $user_info, $sourcedir;
]]></search>
			<add><![CDATA[
function BoardIndex()
{
	global $txt, $scripturl, $db_prefix, $ID_MEMBER, $user_info, $sourcedir, $modSettings;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			IFNULL(mods_mem.ID_MEMBER, 0) AS ID_MODERATOR, mods_mem.realName AS modRealName
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}categories AS c ON (c.ID_CAT = b.ID_CAT)
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
]]></search>
			<add><![CDATA[
			IFNULL(mods_mem.ID_MEMBER, 0) AS ID_MODERATOR, mods_mem.realName AS modRealName, t.pretty_url
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}categories AS c ON (c.ID_CAT = b.ID_CAT)
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
			LEFT JOIN {$db_prefix}topics AS t ON (t.ID_TOPIC = m.ID_TOPIC)
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0',
					'link' => '<a href="' . $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0">' . $row_board['boardName'] . '</a>'
				);
]]></search>
			<add><![CDATA[
					'href' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row_board['ID_BOARD']]) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/0/',
				);
				$this_category[$row_board['ID_BOARD']]['link'] = '<a href="' . $this_category[$row_board['ID_BOARD']]['href'] . '">' . $row_board['boardName'] . '</a>';
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
				'new' => empty($row_board['isRead']) && $row_board['posterName'] != '',
				'topics' => $row_board['numTopics'],
				'posts' => $row_board['numPosts'],
				'href' => $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0">' . $row_board['boardName'] . '</a>'
			);
]]></search>
			<add><![CDATA[
				'new' => empty($row_board['isRead']) && $row_board['posterName'] != '',
				'topics' => $row_board['numTopics'],
				'posts' => $row_board['numPosts'],
				'href' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls']) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/0/',
			);
			$this_category[$row_board['ID_PARENT']]['children'][$row_board['ID_BOARD']]['link'] = '<a href="' . $this_category[$row_board['ID_PARENT']]['children'][$row_board['ID_BOARD']]['href'] . '">' . $row_board['boardName'] . '</a>';
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
			$this_last_post['href'] = $scripturl . '?topic=' . $row_board['ID_TOPIC'] . '.msg' . ($user_info['is_guest'] ? $modSettings['maxMsgID'] : $row_board['new_from']) . (empty($row_board['isRead']) ? ';boardseen' : '') . '#new';
]]></search>
			<add><![CDATA[
			$this_last_post['href'] = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row_board['ID_BOARD']]) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/' . (isset($row_board['pretty_url']) && $row_board['pretty_url'] != '' ? $row_board['pretty_url'] : $row_board['ID_TOPIC']) . '/msg' . ($user_info['is_guest'] ? $modSettings['maxMsgID'] : $row_board['new_from']) . (empty($row_board['isRead']) ? '/?boardseen' : '/') . '#new';
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[
function Display()
{
	global $scripturl, $txt, $db_prefix, $modSettings, $context, $settings;
]]></search>
			<add><![CDATA[
function Display()
{
	global $scripturl, $txt, $db_prefix, $modSettings, $context, $settings, $pretty_board, $pretty_topic;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			t.numReplies, t.numViews, t.locked, ms.subject, t.isSticky, t.ID_POLL,
]]></search>
			<add><![CDATA[
			t.numReplies, t.numViews, t.locked, ms.subject, t.isSticky, t.ID_POLL, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	$context['previous_next'] = $modSettings['enablePreviousNext'] ? '<a href="' . $scripturl . '?topic=' . $topic . '.0;prev_next=prev#new">' . $txt['previous_next_back'] . '</a> <a href="' . $scripturl . '?topic=' . $topic . '.0;prev_next=next#new">' . $txt['previous_next_forward'] . '</a>' : '';
]]></search>
			<add><![CDATA[
	$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board) . '/';
	$pretty_topic = $pretty_board . (isset($topicinfo['pretty_url']) && $topicinfo['pretty_url'] != '' ? $topicinfo['pretty_url'] : $topic) . '/';
	$context['previous_next'] = $modSettings['enablePreviousNext'] ? '<a href="' . $pretty_topic . '0/?prev_next=prev#new">' . $txt['previous_next_back'] . '</a> <a href="' . $pretty_topic . '0/?prev_next=next#new">' . $txt['previous_next_forward'] . '</a>' : '';
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
	$context['page_index'] = constructPageIndex($scripturl . '?topic=' . $topic . '.%d', $_REQUEST['start'], $topicinfo['numReplies'] + 1, $modSettings['defaultMaxMessages'], true);
]]></search>
			<add><![CDATA[
	$context['page_index'] = constructPageIndex($pretty_topic . '%d/', $_REQUEST['start'], $topicinfo['numReplies'] + 1, $modSettings['defaultMaxMessages'], true);
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
		'first' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $scripturl . '?topic=' . $topic . '.0' : '',
		'prev' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $scripturl . '?topic=' . $topic . '.' . ($_REQUEST['start'] - $modSettings['defaultMaxMessages']) : '',
		'next' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $scripturl . '?topic=' . $topic. '.' . ($_REQUEST['start'] + $modSettings['defaultMaxMessages']) : '',
		'last' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $scripturl . '?topic=' . $topic. '.' . (floor($topicinfo['numReplies'] / $modSettings['defaultMaxMessages']) * $modSettings['defaultMaxMessages']) : '',
		'up' => $scripturl . '?board=' . $board . '.0'
]]></search>
			<add><![CDATA[
		'first' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $pretty_topic . '0/' : '',
		'prev' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $pretty_topic . ($_REQUEST['start'] - $modSettings['defaultMaxMessages']) . '/' : '',
		'next' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $pretty_topic . ($_REQUEST['start'] + $modSettings['defaultMaxMessages']) . '/' : '',
		'last' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $pretty_topic . (floor($topicinfo['numReplies'] / $modSettings['defaultMaxMessages']) * $modSettings['defaultMaxMessages']) . '/' : '',
		'up' => $pretty_board . '0/'
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
		'url' => $scripturl . '?topic=' . $topic . '.0',
]]></search>
			<add><![CDATA[
		'url' => $pretty_topic . '0/',
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
				'modify_href' => $scripturl . '?action=post;msg=' . $topicinfo['ID_FIRST_MSG'] . ';topic=' . $topic . '.0;calendar;eventid=' . $row['ID_EVENT'] . ';sesc=' . $context['session_id'],
]]></search>
			<add><![CDATA[
				'modify_href' => $pretty_topic . '0/?action=post;msg=' . $topicinfo['ID_FIRST_MSG'] . ';calendar;eventid=' . $row['ID_EVENT'] . ';sesc=' . $context['session_id'],
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
function prepareDisplayContext($reset = false)
{
	global $settings, $txt, $modSettings, $scripturl, $options, $user_info;
]]></search>
			<add><![CDATA[
function prepareDisplayContext($reset = false)
{
	global $settings, $txt, $modSettings, $scripturl, $options, $user_info, $pretty_board, $pretty_topic;
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
		'href' => $scripturl . '?topic=' . $topic . '.msg' . $message['ID_MSG'] . '#msg' . $message['ID_MSG'],
		'link' => '<a href="' . $scripturl . '?topic=' . $topic . '.msg' . $message['ID_MSG'] . '#msg' . $message['ID_MSG'] . '">' . $message['subject'] . '</a>',
]]></search>
			<add><![CDATA[
		'href' => $pretty_topic . 'msg' . $message['ID_MSG'] . '/#msg' . $message['ID_MSG'],
		'link' => '<a href="' . $pretty_topic . 'msg' . $message['ID_MSG'] . '/#msg' . $message['ID_MSG'] . '">' . $message['subject'] . '</a>',
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Load.php">
		<operation error="skip">
			<search position="replace"><![CDATA[
			array_reverse($board_info['parent_boards']),
			array(array(
				'url' => $scripturl . '?board=' . $board . '.0',
]]></search>
			<add><![CDATA[
			array_reverse($board_info['parent_boards']),
			array(array(
				'url' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board) . '/0/',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
function getBoardParents($id_parent)
{
	global $db_prefix, $scripturl, $txt;
]]></search>
			<add><![CDATA[
function getBoardParents($id_parent)
{
	global $db_prefix, $scripturl, $txt, $modSettings, $context;
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
				$boards[$row['ID_BOARD']] = array(
					'url' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
]]></search>
			<add><![CDATA[
				$boards[$row['ID_BOARD']] = array(
					'url' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/0/',
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/MessageIndex.php">
		<operation>
			<search position="replace"><![CDATA[
function MessageIndex()
{
	global $txt, $scripturl, $board, $db_prefix;
]]></search>
			<add><![CDATA[
function MessageIndex()
{
	global $txt, $scripturl, $board, $db_prefix, $modSettings;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	if (isset($_REQUEST['sort']))
		$context['page_index'] = constructPageIndex($scripturl . '?board=' . $board . '.%d;sort=' . $_REQUEST['sort'] . (isset($_REQUEST['desc']) ? ';desc' : ''), $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
	else
		$context['page_index'] = constructPageIndex($scripturl . '?board=' . $board . '.%d', $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
]]></search>
			<add><![CDATA[
	$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board);
	if (isset($_REQUEST['sort']))
		$context['page_index'] = constructPageIndex($pretty_board . '/%d/?sort=' . $_REQUEST['sort'] . (isset($_REQUEST['desc']) ? ';desc' : ''), $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
	else
		$context['page_index'] = constructPageIndex($pretty_board . '/%d/', $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			mem2.realName AS modRealName
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
]]></search>
			<add><![CDATA[
			mem2.realName AS modRealName, t.pretty_url
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
			LEFT JOIN {$db_prefix}topics AS t ON (t.ID_TOPIC = m.ID_TOPIC)
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				$context['boards'][$row_board['ID_BOARD']] = array(
]]></search>
			<add><![CDATA[
				$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row_board['ID_BOARD']]) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/';
				$pretty_topic = $pretty_board . (isset($row_board['pretty_url']) && $row_board['pretty_url'] != '' ? $row_board['pretty_url'] : $row_board['ID_TOPIC']) . '/';
				$context['boards'][$row_board['ID_BOARD']] = array(
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
						'href' => $row_board['subject'] != '' ? $scripturl . '?topic=' . $row_board['ID_TOPIC'] . '.new' . (empty($row_board['isRead']) ? ';boardseen' : '') . '#new' : '',
						'link' => $row_board['subject'] != '' ? '<a href="' . $scripturl . '?topic=' . $row_board['ID_TOPIC'] . '.new' . (empty($row_board['isRead']) ? ';boardseen' : '') . '#new" title="' . $row_board['subject'] . '">' . $short_subject . '</a>' : $txt[470]
]]></search>
			<add><![CDATA[
						'href' => $row_board['subject'] != '' ? $pretty_topic . 'new/' . (empty($row_board['isRead']) ? '?boardseen' : '') . '#new' : '',
						'link' => $row_board['subject'] != '' ? '<a href="' . $pretty_topic . 'new/' . (empty($row_board['isRead']) ? '?boardseen' : '') . '#new" title="' . $row_board['subject'] . '">' . $short_subject . '</a>' : $txt[470]
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0',
					'link' => '<a href="' . $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0">' . $row_board['name'] . '</a>'
				);
]]></search>
			<add><![CDATA[
					'href' => $pretty_board . '0/',
					'link' => '<a href="' . $pretty_board . '0/">' . $row_board['name'] . '</a>'
				);
]]></add>
		</operation>
		
		<operation error="skip">
			<search position="replace"><![CDATA[
				'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['name'] . '</a>'
			);
]]></search>
			<add><![CDATA[
				'href' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/0/',
			);
			$context['boards'][$row['ID_PARENT']]['children'][$row['ID_BOARD']]['link'] = '<a href="' . $context['boards'][$row['ID_PARENT']]['children'][$row['ID_BOARD']]['href'] . '">' . $row['name'] . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	// Grab the appropriate topic information...
	if (!$pre_query || !empty($topic_ids))
	{
		$result = db_query("
			SELECT
				t.ID_TOPIC, t.numReplies, t.locked, t.numViews, t.isSticky, t.ID_POLL,
]]></search>
			<add><![CDATA[
	$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board) . '/';

	// Grab the appropriate topic information...
	if (!$pre_query || !empty($topic_ids))
	{
		$result = db_query("
			SELECT
				t.ID_TOPIC, t.numReplies, t.locked, t.numViews, t.isSticky, t.ID_POLL, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		// Begin 'printing' the message index for current board.
		while ($row = mysql_fetch_assoc($result))
		{
]]></search>
			<add><![CDATA[
		// Begin 'printing' the message index for current board.
		while ($row = mysql_fetch_assoc($result))
		{
			$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
					$tmppages[] = '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.' . $tmpb . '">' . $tmpa . '</a>';
]]></search>
			<add><![CDATA[
					$tmppages[] = '<a href="' . $pretty_topic . $tmpb . '/">' . $tmpa . '</a>';
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
					$pages .= ' &nbsp;<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0;all">' . $txt[190] . '</a>';
]]></search>
			<add><![CDATA[
					$pages .= ' &nbsp;<a href="' . $pretty_topic . '0/?all">' . $txt[190] . '</a>';
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
					'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0">' . $row['firstSubject'] . '</a>'
]]></search>
			<add><![CDATA[
					'href' => $pretty_topic . '0/',
					'link' => '<a href="' . $pretty_topic . '0/">' . $row['firstSubject'] . '</a>'
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['ID_LAST_MSG']) . '#new',
					'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['ID_LAST_MSG']) . '#new">' . $row['lastSubject'] . '</a>'
]]></search>
			<add><![CDATA[
					'href' => $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['ID_LAST_MSG']) . '/#new',
					'link' => '<a href="' . $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['ID_LAST_MSG']) . '/#new">' . $row['lastSubject'] . '</a>'
]]></add>
		</operation>

		<operation error="skip">
			<search position="replace"><![CDATA[
				'new_href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['new_from'] . '#new',
]]></search>
			<add><![CDATA[
				'new_href' => $pretty_topic . 'msg' . $row['new_from'] . '/#new',
]]></add>
		</operation>
	</file>

</modification>
