<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>el:prettyurls-ext-none</id>
	<version>0.3</version>

	<file name="$boarddir/SSI.php">
		<operation>
			<search position="replace"><![CDATA[
			IFNULL(lt.ID_MSG, IFNULL(lmr.ID_MSG, -1)) + 1 AS new_from') . ", LEFT(m.body, 384) AS body, m.smileysEnabled
		FROM ({$db_prefix}messages AS m, {$db_prefix}boards AS b)
]]></search>
			<add><![CDATA[
			t.pretty_url, IFNULL(lt.ID_MSG, IFNULL(lmr.ID_MSG, -1)) + 1 AS new_from') . ", LEFT(m.body, 384) AS body, m.smileysEnabled
		FROM ({$db_prefix}messages AS m, {$db_prefix}boards AS b)
			LEFT JOIN {$db_prefix}topics AS t ON (t.ID_TOPIC = m.ID_TOPIC)
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		censorText($row['body']);

		// Build the array.
		$posts[] = array(
			'board' => array(
				'id' => $row['ID_BOARD'],
				'name' => $row['bName'],
				'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['bName'] . '</a>'
]]></search>
			<add><![CDATA[
		censorText($row['body']);

		// Build the array.
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/';
		$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';
		$posts[] = array(
			'board' => array(
				'id' => $row['ID_BOARD'],
				'name' => $row['bName'],
				'href' => $pretty_board,
				'link' => '<a href="' . $pretty_board . '0/">' . $row['bName'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . ';topicseen#new',
			'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG'] . '">' . $row['subject'] . '</a>',
]]></search>
			<add><![CDATA[
			'href' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/?topicseen#new',
			'link' => '<a href="' . $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG'] . '">' . $row['subject'] . '</a>',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					', $post['new'] ? '' : '<a href="' . $scripturl . '?topic=' . $post['topic'] . '.msg' . $post['new_from'] . ';topicseen#new"><img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/new.gif" alt="' . $txt[302] . '" border="0" /></a>', '
				</td>
				<td align="right" nowrap="nowrap">
					', $post['time'], '
				</td>
			</tr>';
	echo '
		</table>';
}

// Recent topic list:   [board] Subject by Poster	Date
]]></search>
			<add><![CDATA[
					', $post['new'] ? '' : '<a href="' . $pretty_topic . 'msg' . $post['new_from'] . '/?topicseen#new"><img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/new.gif" alt="' . $txt[302] . '" border="0" /></a>', '
				</td>
				<td align="right" nowrap="nowrap">
					', $post['time'], '
				</td>
			</tr>';
	echo '
		</table>';
}

// Recent topic list:   [board] Subject by Poster	Date
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			m.posterTime, ms.subject, m.ID_TOPIC, m.ID_MEMBER, m.ID_MSG, b.ID_BOARD, b.name AS bName,
]]></search>
			<add><![CDATA[
			m.posterTime, ms.subject, m.ID_TOPIC, m.ID_MEMBER, m.ID_MSG, b.ID_BOARD, b.name AS bName, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			$icon_sources[$row['icon']] = file_exists($settings['theme_dir'] . '/images/post/' . $row['icon'] . '.gif') ? 'images_url' : 'default_images_url';

		// Build the array.
		$posts[] = array(
			'board' => array(
				'id' => $row['ID_BOARD'],
				'name' => $row['bName'],
				'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['bName'] . '</a>'
]]></search>
			<add><![CDATA[
			$icon_sources[$row['icon']] = file_exists($settings['theme_dir'] . '/images/post/' . $row['icon'] . '.gif') ? 'images_url' : 'default_images_url';

		// Build the array.
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/';
		$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';
		$posts[] = array(
			'board' => array(
				'id' => $row['ID_BOARD'],
				'name' => $row['bName'],
				'href' => $pretty_board,
				'link' => '<a href="' . $pretty_board . '0/">' . $row['bName'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . ';topicseen#new',
			'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#new">' . $row['subject'] . '</a>',
]]></search>
			<add><![CDATA[
			'href' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/?topicseen#new',
			'link' => '<a href="' . $pretty_topic . 'msg' . $row['ID_MSG'] . '/#new">' . $row['subject'] . '</a>',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					', $post['new'] ? '' : '<a href="' . $scripturl . '?topic=' . $post['topic'] . '.msg' . $post['new_from'] . ';topicseen#new"><img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/new.gif" alt="' . $txt[302] . '" border="0" /></a>', '
				</td>
				<td align="right" nowrap="nowrap">
					', $post['time'], '
				</td>
			</tr>';
	echo '
		</table>';
}

// Show the top poster's name and profile link.
]]></search>
			<add><![CDATA[
					', $post['new'] ? '' : '<a href="' . $pretty_topic . 'msg' . $post['new_from'] . '/?topicseen#new"><img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/new.gif" alt="' . $txt[302] . '" border="0" /></a>', '
				</td>
				<td align="right" nowrap="nowrap">
					', $post['time'], '
				</td>
			</tr>';
	echo '
		</table>';
}

// Show the top poster's name and profile link.
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	while ($row = mysql_fetch_assoc($request))
		$boards[] = array(
			'id' => $row['ID_BOARD'],
			'num_posts' => $row['numPosts'],
			'num_topics' => $row['numTopics'],
			'name' => $row['name'],
			'new' => empty($row['isRead']),
			'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
			'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['name'] . '</a>'
		);
]]></search>
			<add><![CDATA[
	while ($row = mysql_fetch_assoc($request))
	{
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/0/';
		$boards[] = array(
			'id' => $row['ID_BOARD'],
			'num_posts' => $row['numPosts'],
			'num_topics' => $row['numTopics'],
			'name' => $row['name'],
			'new' => empty($row['isRead']),
			'href' => $pretty_board,
			'link' => '<a href="' . $pretty_board . '">' . $row['name'] . '</a>'
		);
	}
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	global $db_prefix, $txt, $scripturl, $ID_MEMBER, $user_info, $modSettings;
]]></search>
			<add><![CDATA[
	global $db_prefix, $txt, $scripturl, $ID_MEMBER, $user_info, $modSettings, $context;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		SELECT m.subject, m.ID_TOPIC, t.numViews, t.numReplies
]]></search>
			<add><![CDATA[
		SELECT m.subject, m.ID_TOPIC, t.numViews, t.numReplies, t.pretty_url, t.ID_BOARD
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		$topics[] = array(
			'id' => $row['ID_TOPIC'],
			'subject' => $row['subject'],
			'num_replies' => $row['numReplies'],
			'num_views' => $row['numViews'],
			'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
			'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0">' . $row['subject'] . '</a>',
]]></search>
			<add><![CDATA[
		$pretty_topic = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/' . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/0/';
		$topics[] = array(
			'id' => $row['ID_TOPIC'],
			'subject' => $row['subject'],
			'num_replies' => $row['numReplies'],
			'num_views' => $row['numViews'],
			'href' => $pretty_topic,
			'link' => '<a href="' . $pretty_topic . '">' . $row['subject'] . '</a>',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			t.numReplies, t.ID_TOPIC, m.ID_MEMBER, m.smileysEnabled, m.ID_MSG, t.locked
]]></search>
			<add><![CDATA[
			t.numReplies, t.ID_TOPIC, m.ID_MEMBER, m.smileysEnabled, m.ID_MSG, t.locked, t.pretty_url, t.ID_BOARD
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		censorText($row['body']);

		$return[] = array(
]]></search>
			<add><![CDATA[
		censorText($row['body']);

		$pretty_topic = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/' . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';
		$return[] = array(
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
			'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0">' . $row['numReplies'] . ' ' . ($row['numReplies'] == 1 ? $txt['smf_news_1'] : $txt['smf_news_2']) . '</a>',
			'replies' => $row['numReplies'],
			'comment_href' => !empty($row['locked']) ? '' : $scripturl . '?action=post;topic=' . $row['ID_TOPIC'] . '.' . $row['numReplies'] . ';num_replies=' . $row['numReplies'],
			'comment_link' => !empty($row['locked']) ? '' : '<a href="' . $scripturl . '?action=post;topic=' . $row['ID_TOPIC'] . '.' . $row['numReplies'] . ';num_replies=' . $row['numReplies'] . '">' . $txt['smf_news_3'] . '</a>',
			'new_comment' => !empty($row['locked']) ? '' : '<a href="' . $scripturl . '?action=post;topic=' . $row['ID_TOPIC'] . '.' . $row['numReplies'] . '">' . $txt['smf_news_3'] . '</a>',
]]></search>
			<add><![CDATA[
			'href' => $pretty_topic . '0/',
			'link' => '<a href="' . $pretty_topic . '0/">' . $row['numReplies'] . ' ' . ($row['numReplies'] == 1 ? $txt['smf_news_1'] : $txt['smf_news_2']) . '</a>',
			'replies' => $row['numReplies'],
			'comment_href' => !empty($row['locked']) ? '' : $pretty_topic . $row['numReplies'] . '/?action=post;num_replies=' . $row['numReplies'],
			'comment_link' => !empty($row['locked']) ? '' : '<a href="' . $pretty_topic . $row['numReplies'] . '?action=post;num_replies=' . $row['numReplies'] . '">' . $txt['smf_news_3'] . '</a>',
			'new_comment' => !empty($row['locked']) ? '' : '<a href="' . $pretty_topic . $row['numReplies'] . '?action=post">' . $txt['smf_news_3'] . '</a>',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	global $db_prefix, $user_info, $scripturl, $modSettings, $txt, $sc, $ID_MEMBER;
]]></search>
			<add><![CDATA[
	global $db_prefix, $user_info, $scripturl, $modSettings, $txt, $sc, $ID_MEMBER, $context;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			cal.ID_BOARD, t.ID_FIRST_MSG
]]></search>
			<add><![CDATA[
			cal.ID_BOARD, t.ID_FIRST_MSG, t.pretty_url
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		// Check if we've already come by an event linked to this same topic with the same title... and don't display it if we have.
]]></search>
			<add><![CDATA[
		$pretty_topic = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/' . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/0/';
		// Check if we've already come by an event linked to this same topic with the same title... and don't display it if we have.
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			'modify_href' => $scripturl . '?action=' . ($row['ID_BOARD'] == 0 ? 'calendar;sa=post;' : 'post;msg=' . $row['ID_FIRST_MSG'] . ';topic=' . $row['ID_TOPIC'] . '.0;calendar;') . 'eventid=' . $row['ID_EVENT'] . ';sesc=' . $sc,
			'href' => $row['ID_BOARD'] == 0 ? '' : $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
			'link' => $row['ID_BOARD'] == 0 ? $row['title'] : '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0">' . $row['title'] . '</a>',
]]></search>
			<add><![CDATA[
			'modify_href' => $pretty_topic . '0/?action=' . ($row['ID_BOARD'] == 0 ? 'calendar;sa=post;' : 'post;msg=' . $row['ID_FIRST_MSG'] . ';calendar;') . 'eventid=' . $row['ID_EVENT'] . ';sesc=' . $sc,
			'href' => $row['ID_BOARD'] == 0 ? '' : $pretty_topic . '0/',
			'link' => $row['ID_BOARD'] == 0 ? $row['title'] : '<a href="' . $pretty_topic . '0/">' . $row['title'] . '</a>',
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/BoardIndex.php">
		<operation>
			<search position="replace"><![CDATA[
function BoardIndex()
{
	global $txt, $scripturl, $db_prefix, $ID_MEMBER, $user_info, $sourcedir;
]]></search>
			<add><![CDATA[
function BoardIndex()
{
	global $txt, $scripturl, $db_prefix, $ID_MEMBER, $user_info, $sourcedir, $modSettings;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			IFNULL(mods_mem.ID_MEMBER, 0) AS ID_MODERATOR, mods_mem.realName AS modRealName
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}categories AS c ON (c.ID_CAT = b.ID_CAT)
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
]]></search>
			<add><![CDATA[
			IFNULL(mods_mem.ID_MEMBER, 0) AS ID_MODERATOR, mods_mem.realName AS modRealName, t.pretty_url
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}categories AS c ON (c.ID_CAT = b.ID_CAT)
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
			LEFT JOIN {$db_prefix}topics AS t ON (t.ID_TOPIC = m.ID_TOPIC)
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0',
					'link' => '<a href="' . $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0">' . $row_board['boardName'] . '</a>'
				);
]]></search>
			<add><![CDATA[
					'href' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row_board['ID_BOARD']]) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/0/',
				);
				$this_category[$row_board['ID_BOARD']]['link'] = '<a href="' . $this_category[$row_board['ID_BOARD']]['href'] . '">' . $row_board['boardName'] . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'new' => empty($row_board['isRead']) && $row_board['posterName'] != '',
				'topics' => $row_board['numTopics'],
				'posts' => $row_board['numPosts'],
				'href' => $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0">' . $row_board['boardName'] . '</a>'
			);
]]></search>
			<add><![CDATA[
				'new' => empty($row_board['isRead']) && $row_board['posterName'] != '',
				'topics' => $row_board['numTopics'],
				'posts' => $row_board['numPosts'],
				'href' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls']) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/0/',
			);
			$this_category[$row_board['ID_PARENT']]['children'][$row_board['ID_BOARD']]['link'] = '<a href="' . $this_category[$row_board['ID_PARENT']]['children'][$row_board['ID_BOARD']]['href'] . '">' . $row_board['boardName'] . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			$this_last_post['href'] = $scripturl . '?topic=' . $row_board['ID_TOPIC'] . '.msg' . ($user_info['is_guest'] ? $modSettings['maxMsgID'] : $row_board['new_from']) . (empty($row_board['isRead']) ? ';boardseen' : '') . '#new';
]]></search>
			<add><![CDATA[
			$this_last_post['href'] = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row_board['ID_BOARD']]) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/' . (isset($row_board['pretty_url']) && $row_board['pretty_url'] != '' ? $row_board['pretty_url'] : $row_board['ID_TOPIC']) . '/msg' . ($user_info['is_guest'] ? $modSettings['maxMsgID'] : $row_board['new_from']) . (empty($row_board['isRead']) ? '/?boardseen' : '/') . '#new';
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[
function Display()
{
	global $scripturl, $txt, $db_prefix, $modSettings, $context, $settings;
]]></search>
			<add><![CDATA[
function Display()
{
	global $scripturl, $txt, $db_prefix, $modSettings, $context, $settings, $pretty_board, $pretty_topic;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			t.numReplies, t.numViews, t.locked, ms.subject, t.isSticky, t.ID_POLL,
]]></search>
			<add><![CDATA[
			t.numReplies, t.numViews, t.locked, ms.subject, t.isSticky, t.ID_POLL, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	$context['previous_next'] = $modSettings['enablePreviousNext'] ? '<a href="' . $scripturl . '?topic=' . $topic . '.0;prev_next=prev#new">' . $txt['previous_next_back'] . '</a> <a href="' . $scripturl . '?topic=' . $topic . '.0;prev_next=next#new">' . $txt['previous_next_forward'] . '</a>' : '';
]]></search>
			<add><![CDATA[
	$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board) . '/';
	$pretty_topic = $pretty_board . (isset($topicinfo['pretty_url']) && $topicinfo['pretty_url'] != '' ? $topicinfo['pretty_url'] : $topic) . '/';
	$context['previous_next'] = $modSettings['enablePreviousNext'] ? '<a href="' . $pretty_topic . '0/?prev_next=prev#new">' . $txt['previous_next_back'] . '</a> <a href="' . $pretty_topic . '0/?prev_next=next#new">' . $txt['previous_next_forward'] . '</a>' : '';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	$context['page_index'] = constructPageIndex($scripturl . '?topic=' . $topic . '.%d', $_REQUEST['start'], $topicinfo['numReplies'] + 1, $modSettings['defaultMaxMessages'], true);
]]></search>
			<add><![CDATA[
	$context['page_index'] = constructPageIndex($pretty_topic . '%d/', $_REQUEST['start'], $topicinfo['numReplies'] + 1, $modSettings['defaultMaxMessages'], true);
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		'first' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $scripturl . '?topic=' . $topic . '.0' : '',
		'prev' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $scripturl . '?topic=' . $topic . '.' . ($_REQUEST['start'] - $modSettings['defaultMaxMessages']) : '',
		'next' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $scripturl . '?topic=' . $topic. '.' . ($_REQUEST['start'] + $modSettings['defaultMaxMessages']) : '',
		'last' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $scripturl . '?topic=' . $topic. '.' . (floor($topicinfo['numReplies'] / $modSettings['defaultMaxMessages']) * $modSettings['defaultMaxMessages']) : '',
		'up' => $scripturl . '?board=' . $board . '.0'
]]></search>
			<add><![CDATA[
		'first' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $pretty_topic . '0/' : '',
		'prev' => $_REQUEST['start'] >= $modSettings['defaultMaxMessages'] ? $pretty_topic . ($_REQUEST['start'] - $modSettings['defaultMaxMessages']) . '/' : '',
		'next' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $pretty_topic . ($_REQUEST['start'] + $modSettings['defaultMaxMessages']) . '/' : '',
		'last' => $_REQUEST['start'] + $modSettings['defaultMaxMessages'] < $topicinfo['numReplies'] + 1 ? $pretty_topic . (floor($topicinfo['numReplies'] / $modSettings['defaultMaxMessages']) * $modSettings['defaultMaxMessages']) . '/' : '',
		'up' => $pretty_board . '0/'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		'url' => $scripturl . '?topic=' . $topic . '.0',
]]></search>
			<add><![CDATA[
		'url' => $pretty_topic . '0/',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'modify_href' => $scripturl . '?action=post;msg=' . $topicinfo['ID_FIRST_MSG'] . ';topic=' . $topic . '.0;calendar;eventid=' . $row['ID_EVENT'] . ';sesc=' . $context['session_id'],
]]></search>
			<add><![CDATA[
				'modify_href' => $pretty_topic . '0/?action=post;msg=' . $topicinfo['ID_FIRST_MSG'] . ';calendar;eventid=' . $row['ID_EVENT'] . ';sesc=' . $context['session_id'],
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
function prepareDisplayContext($reset = false)
{
	global $settings, $txt, $modSettings, $scripturl, $options, $user_info;
]]></search>
			<add><![CDATA[
function prepareDisplayContext($reset = false)
{
	global $settings, $txt, $modSettings, $scripturl, $options, $user_info, $pretty_board, $pretty_topic;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		'href' => $scripturl . '?topic=' . $topic . '.msg' . $message['ID_MSG'] . '#msg' . $message['ID_MSG'],
		'link' => '<a href="' . $scripturl . '?topic=' . $topic . '.msg' . $message['ID_MSG'] . '#msg' . $message['ID_MSG'] . '">' . $message['subject'] . '</a>',
]]></search>
			<add><![CDATA[
		'href' => $pretty_topic . 'msg' . $message['ID_MSG'] . '/#msg' . $message['ID_MSG'],
		'link' => '<a href="' . $pretty_topic . 'msg' . $message['ID_MSG'] . '/#msg' . $message['ID_MSG'] . '">' . $message['subject'] . '</a>',
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Load.php">
		<operation>
			<search position="replace"><![CDATA[
			array_reverse($board_info['parent_boards']),
			array(array(
				'url' => $scripturl . '?board=' . $board . '.0',
]]></search>
			<add><![CDATA[
			array_reverse($board_info['parent_boards']),
			array(array(
				'url' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board) . '/0/',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
function getBoardParents($id_parent)
{
	global $db_prefix, $scripturl, $txt;
]]></search>
			<add><![CDATA[
function getBoardParents($id_parent)
{
	global $db_prefix, $scripturl, $txt, $modSettings, $context;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				$boards[$row['ID_BOARD']] = array(
					'url' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
]]></search>
			<add><![CDATA[
				$boards[$row['ID_BOARD']] = array(
					'url' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/0/',
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/MessageIndex.php">
		<operation>
			<search position="replace"><![CDATA[
function MessageIndex()
{
	global $txt, $scripturl, $board, $db_prefix;
]]></search>
			<add><![CDATA[
function MessageIndex()
{
	global $txt, $scripturl, $board, $db_prefix, $modSettings;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	if (isset($_REQUEST['sort']))
		$context['page_index'] = constructPageIndex($scripturl . '?board=' . $board . '.%d;sort=' . $_REQUEST['sort'] . (isset($_REQUEST['desc']) ? ';desc' : ''), $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
	else
		$context['page_index'] = constructPageIndex($scripturl . '?board=' . $board . '.%d', $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
]]></search>
			<add><![CDATA[
	$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board);
	if (isset($_REQUEST['sort']))
		$context['page_index'] = constructPageIndex($pretty_board . '/%d/?sort=' . $_REQUEST['sort'] . (isset($_REQUEST['desc']) ? ';desc' : ''), $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
	else
		$context['page_index'] = constructPageIndex($pretty_board . '/%d/', $_REQUEST['start'], $board_info['num_topics'], $maxindex, true);
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			mem2.realName AS modRealName
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
]]></search>
			<add><![CDATA[
			mem2.realName AS modRealName, t.pretty_url
		FROM {$db_prefix}boards AS b
			LEFT JOIN {$db_prefix}messages AS m ON (m.ID_MSG = b.ID_LAST_MSG)
			LEFT JOIN {$db_prefix}topics AS t ON (t.ID_TOPIC = m.ID_TOPIC)
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				$context['boards'][$row_board['ID_BOARD']] = array(
]]></search>
			<add><![CDATA[
				$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row_board['ID_BOARD']]) ? $context['pretty']['board_urls'][$row_board['ID_BOARD']] : $row_board['ID_BOARD']) . '/';
				$pretty_topic = $pretty_board . (isset($row_board['pretty_url']) && $row_board['pretty_url'] != '' ? $row_board['pretty_url'] : $row_board['ID_TOPIC']) . '/';
				$context['boards'][$row_board['ID_BOARD']] = array(
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
						'href' => $row_board['subject'] != '' ? $scripturl . '?topic=' . $row_board['ID_TOPIC'] . '.new' . (empty($row_board['isRead']) ? ';boardseen' : '') . '#new' : '',
						'link' => $row_board['subject'] != '' ? '<a href="' . $scripturl . '?topic=' . $row_board['ID_TOPIC'] . '.new' . (empty($row_board['isRead']) ? ';boardseen' : '') . '#new" title="' . $row_board['subject'] . '">' . $short_subject . '</a>' : $txt[470]
]]></search>
			<add><![CDATA[
						'href' => $row_board['subject'] != '' ? $pretty_topic . 'new/' . (empty($row_board['isRead']) ? '?boardseen' : '') . '#new' : '',
						'link' => $row_board['subject'] != '' ? '<a href="' . $pretty_topic . 'new/' . (empty($row_board['isRead']) ? '?boardseen' : '') . '#new" title="' . $row_board['subject'] . '">' . $short_subject . '</a>' : $txt[470]
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0',
					'link' => '<a href="' . $scripturl . '?board=' . $row_board['ID_BOARD'] . '.0">' . $row_board['name'] . '</a>'
				);
]]></search>
			<add><![CDATA[
					'href' => $pretty_board . '0/',
					'link' => '<a href="' . $pretty_board . '0/">' . $row_board['name'] . '</a>'
				);
]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[
				'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['name'] . '</a>'
			);
]]></search>
			<add><![CDATA[
				'href' => $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/0/',
			);
			$context['boards'][$row['ID_PARENT']]['children'][$row['ID_BOARD']]['link'] = '<a href="' . $context['boards'][$row['ID_PARENT']]['children'][$row['ID_BOARD']]['href'] . '">' . $row['name'] . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	// Grab the appropriate topic information...
	if (!$pre_query || !empty($topic_ids))
	{
		$result = db_query("
			SELECT
				t.ID_TOPIC, t.numReplies, t.locked, t.numViews, t.isSticky, t.ID_POLL,
]]></search>
			<add><![CDATA[
	$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board) . '/';

	// Grab the appropriate topic information...
	if (!$pre_query || !empty($topic_ids))
	{
		$result = db_query("
			SELECT
				t.ID_TOPIC, t.numReplies, t.locked, t.numViews, t.isSticky, t.ID_POLL, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		// Begin 'printing' the message index for current board.
		while ($row = mysql_fetch_assoc($result))
		{
]]></search>
			<add><![CDATA[
		// Begin 'printing' the message index for current board.
		while ($row = mysql_fetch_assoc($result))
		{
			$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					$tmppages[] = '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.' . $tmpb . '">' . $tmpa . '</a>';
]]></search>
			<add><![CDATA[
					$tmppages[] = '<a href="' . $pretty_topic . $tmpb . '/">' . $tmpa . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					$pages .= ' &nbsp;<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0;all">' . $txt[190] . '</a>';
]]></search>
			<add><![CDATA[
					$pages .= ' &nbsp;<a href="' . $pretty_topic . '0/?all">' . $txt[190] . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
					'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0">' . $row['firstSubject'] . '</a>'
]]></search>
			<add><![CDATA[
					'href' => $pretty_topic . '0/',
					'link' => '<a href="' . $pretty_topic . '0/">' . $row['firstSubject'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['ID_LAST_MSG']) . '#new',
					'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['ID_LAST_MSG']) . '#new">' . $row['lastSubject'] . '</a>'
]]></search>
			<add><![CDATA[
					'href' => $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['ID_LAST_MSG']) . '/#new',
					'link' => '<a href="' . $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['ID_LAST_MSG']) . '/#new">' . $row['lastSubject'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'new_href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['new_from'] . '#new',
]]></search>
			<add><![CDATA[
				'new_href' => $pretty_topic . 'msg' . $row['new_from'] . '/#new',
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/News.php">
		<operation>
			<search position="replace"><![CDATA[
function getXmlNews($xml_format)
{
	global $db_prefix, $user_info, $scripturl, $modSettings, $board;
]]></search>
			<add><![CDATA[
function getXmlNews($xml_format)
{
	global $db_prefix, $user_info, $scripturl, $modSettings, $board, $context;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			m.smileysEnabled, m.posterTime, m.ID_MSG, m.subject, m.body, t.ID_TOPIC, t.ID_BOARD,
]]></search>
			<add><![CDATA[
			m.smileysEnabled, m.posterTime, m.ID_MSG, m.subject, m.body, t.ID_TOPIC, t.ID_BOARD, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		// Being news, this actually makes sense in rss format.
		if ($xml_format == 'rss' || $xml_format == 'rss2')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
				'description' => cdata_parse($row['body']),
				'author' => (!empty($modSettings['guest_hideContacts']) && $user_info['is_guest']) || (!empty($row['hideEmail']) && !empty($modSettings['allow_hideEmail']) && !allowedTo('moderate_forum')) ? null : $row['posterEmail'],
				'comments' => $scripturl . '?action=post;topic=' . $row['ID_TOPIC'] . '.0',
]]></search>
			<add><![CDATA[
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/';
		$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';

		// Being news, this actually makes sense in rss format.
		if ($xml_format == 'rss' || $xml_format == 'rss2')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $pretty_topic . '0/',
				'description' => cdata_parse($row['body']),
				'author' => (!empty($modSettings['guest_hideContacts']) && $user_info['is_guest']) || (!empty($row['hideEmail']) && !empty($modSettings['allow_hideEmail']) && !allowedTo('moderate_forum')) ? null : $row['posterEmail'],
				'comments' => $pretty_topic . '0/?action=post',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'guid' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG']
			);
		elseif ($xml_format == 'rdf')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
				'description' => cdata_parse($row['body']),
			);
		elseif ($xml_format == 'atom')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0',
				'summary' => cdata_parse($row['body']),
				'author' => array('name' => $row['posterName']),
				'created' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'issued' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'modified' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', empty($row['modifiedTime']) ? $row['posterTime'] : $row['modifiedTime']),
				'id' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG']
]]></search>
			<add><![CDATA[
				'guid' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG']
			);
		elseif ($xml_format == 'rdf')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $pretty_topic . '0/',
				'description' => cdata_parse($row['body']),
			);
		elseif ($xml_format == 'atom')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $pretty_topic . '0/',
				'summary' => cdata_parse($row['body']),
				'author' => array('name' => $row['posterName']),
				'created' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'issued' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'modified' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', empty($row['modifiedTime']) ? $row['posterTime'] : $row['modifiedTime']),
				'id' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG']
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					'link' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0'
				),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0'
]]></search>
			<add><![CDATA[
					'link' => $pretty_board . '0/'
				),
				'link' => $pretty_topic . '0/'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
function getXmlRecent($xml_format)
{
	global $db_prefix, $user_info, $scripturl, $modSettings, $board;
]]></search>
			<add><![CDATA[
function getXmlRecent($xml_format)
{
	global $db_prefix, $user_info, $scripturl, $modSettings, $board, $context;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			m.smileysEnabled, m.posterTime, m.ID_MSG, m.subject, m.body, m.ID_TOPIC, t.ID_BOARD,
]]></search>
			<add><![CDATA[
			m.smileysEnabled, m.posterTime, m.ID_MSG, m.subject, m.body, m.ID_TOPIC, t.ID_BOARD, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		// Doesn't work as well as news, but it kinda does..
		if ($xml_format == 'rss' || $xml_format == 'rss2')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG'],
				'description' => cdata_parse($row['body']),
				'author' => (!empty($modSettings['guest_hideContacts']) && $user_info['is_guest']) || (!empty($row['hideEmail']) && !empty($modSettings['allow_hideEmail']) && !allowedTo('moderate_forum')) ? null : $row['posterEmail'],
				'category' => cdata_parse($row['bname']),
				'comments' => $scripturl . '?action=post;topic=' . $row['ID_TOPIC'] . '.0',
				'pubDate' => gmdate('D, d M Y H:i:s \G\M\T', $row['posterTime']),
				'guid' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG']
			);
		elseif ($xml_format == 'rdf')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG'],
				'description' => cdata_parse($row['body']),
			);
		elseif ($xml_format == 'atom')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG'],
				'summary' => cdata_parse($row['body']),
				'author' => array('name' => $row['posterName']),
				'created' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'issued' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'modified' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', empty($row['modifiedTime']) ? $row['posterTime'] : $row['modifiedTime']),
				'id' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG']
]]></search>
			<add><![CDATA[
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/';
		$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';

		// Doesn't work as well as news, but it kinda does..
		if ($xml_format == 'rss' || $xml_format == 'rss2')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG'],
				'description' => cdata_parse($row['body']),
				'author' => (!empty($modSettings['guest_hideContacts']) && $user_info['is_guest']) || (!empty($row['hideEmail']) && !empty($modSettings['allow_hideEmail']) && !allowedTo('moderate_forum')) ? null : $row['posterEmail'],
				'category' => cdata_parse($row['bname']),
				'comments' => $pretty_topic . '0/?action=post',
				'pubDate' => gmdate('D, d M Y H:i:s \G\M\T', $row['posterTime']),
				'guid' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG']
			);
		elseif ($xml_format == 'rdf')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG'],
				'description' => cdata_parse($row['body']),
			);
		elseif ($xml_format == 'atom')
			$data[] = array(
				'title' => cdata_parse($row['subject']),
				'link' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG'],
				'summary' => cdata_parse($row['body']),
				'author' => array('name' => $row['posterName']),
				'created' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'issued' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', $row['posterTime']),
				'modified' => gmstrftime('%Y-%m-%dT%H:%M:%SZ', empty($row['modifiedTime']) ? $row['posterTime'] : $row['modifiedTime']),
				'id' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG']
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
					'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.new#new'
				),
				'board' => array(
					'name' => cdata_parse($row['bname']),
					'id' => $row['ID_BOARD'],
					'link' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0'
				),
				'link' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG']
]]></search>
			<add><![CDATA[
					'link' => $pretty_topic . 'new/#new'
				),
				'board' => array(
					'name' => cdata_parse($row['bname']),
					'id' => $row['ID_BOARD'],
					'link' => $pretty_board . '0/'
				),
				'link' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG']
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Recent.php">
		<operation>
			<search position="replace"><![CDATA[
function getLastPost()
{
	global $db_prefix, $user_info, $scripturl, $modSettings, $func;
]]></search>
			<add><![CDATA[
function getLastPost()
{
	global $db_prefix, $user_info, $scripturl, $modSettings, $func, $context;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		SELECT ml.posterTime, ml.subject, ml.ID_TOPIC, ml.posterName, LEFT(ml.body, 384) AS body, ml.smileysEnabled
		FROM ({$db_prefix}boards AS b, {$db_prefix}messages AS ml)
]]></search>
			<add><![CDATA[
		SELECT ml.posterTime, ml.subject, ml.ID_TOPIC, ml.posterName, LEFT(ml.body, 384) AS body, ml.smileysEnabled, b.ID_BOARD, t.pretty_url
		FROM ({$db_prefix}boards AS b, {$db_prefix}messages AS ml)
			LEFT JOIN {$db_prefix}topics AS t ON (t.ID_TOPIC = ml.ID_TOPIC)
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
	// Send the data.
]]></search>
			<add><![CDATA[
	$pretty_topic = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/' . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';

	// Send the data.
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.new;topicseen#new',
		'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.new;topicseen#new">' . $row['subject'] . '</a>'
]]></search>
			<add><![CDATA[
		'href' => $pretty_topic . 'new/?topicseen#new',
		'link' => '<a href="' . $pretty_topic . 'new/?topicseen#new">' . $row['subject'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
function getLastPosts($showlatestcount)
{
	global $scripturl, $txt, $db_prefix, $user_info, $modSettings, $func;
]]></search>
			<add><![CDATA[
function getLastPosts($showlatestcount)
{
	global $scripturl, $txt, $db_prefix, $user_info, $modSettings, $func, $context;
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			IFNULL(mem.realName, m.posterName) AS posterName, t.ID_BOARD, b.name AS bName,
]]></search>
			<add><![CDATA[
			IFNULL(mem.realName, m.posterName) AS posterName, t.ID_BOARD, b.name AS bName, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		// Build the array.
		$posts[] = array(
			'board' => array(
				'id' => $row['ID_BOARD'],
				'name' => $row['bName'],
				'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['bName'] . '</a>'
]]></search>
			<add><![CDATA[
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/';
		$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/msg' . $row['ID_MSG'] . '/?topicseen#msg' . $row['ID_MSG'];

		// Build the array.
		$posts[] = array(
			'board' => array(
				'id' => $row['ID_BOARD'],
				'name' => $row['bName'],
				'href' => $pretty_board . '0/',
				'link' => '<a href="' . $pretty_board . '0/">' . $row['bName'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . ';topicseen#msg' . $row['ID_MSG'],
			'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . ';topicseen#msg' . $row['ID_MSG'] . '">' . $row['subject'] . '</a>'
]]></search>
			<add><![CDATA[
			'href' => $pretty_topic,
			'link' => '<a href="' . $pretty_topic . '">' . $row['subject'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		$context['page_index'] = constructPageIndex($scripturl . '?action=recent;board=' . $board . '.%d', $_REQUEST['start'], min(100, $total_posts), 10, true);
]]></search>
			<add><![CDATA[
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$board]) ? $context['pretty']['board_urls'][$board] : $board);
		$context['page_index'] = constructPageIndex($pretty_board . '/%d/' . '?action=recent', $_REQUEST['start'], min(100, $total_posts), 10, true);
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
			m.ID_MSG, m.subject, m.smileysEnabled, m.posterTime, m.body, m.ID_TOPIC, t.ID_BOARD, b.ID_CAT,
]]></search>
			<add><![CDATA[
			m.ID_MSG, m.subject, m.smileysEnabled, m.posterTime, m.body, m.ID_TOPIC, t.ID_BOARD, b.ID_CAT, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		// And build the array.
		$context['posts'][$row['ID_MSG']] = array(
]]></search>
			<add><![CDATA[
		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/';
		$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';

		// And build the array.
		$context['posts'][$row['ID_MSG']] = array(
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['bname'] . '</a>'
			),
			'topic' => $row['ID_TOPIC'],
			'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG'],
			'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['ID_MSG'] . '#msg' . $row['ID_MSG'] . '">' . $row['subject'] . '</a>',
]]></search>
			<add><![CDATA[
				'href' => $pretty_board . '0/',
				'link' => '<a href="' . $pretty_board . '0/">' . $row['bname'] . '</a>'
			),
			'topic' => $row['ID_TOPIC'],
			'href' => $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG'],
			'link' => '<a href="' . $pretty_topic . 'msg' . $row['ID_MSG'] . '/#msg' . $row['ID_MSG'] . '">' . $row['subject'] . '</a>',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				ms.subject AS firstSubject, ms.posterTime AS firstPosterTime, ms.ID_TOPIC, t.ID_BOARD, b.name AS bname,
]]></search>
			<add><![CDATA[
				ms.subject AS firstSubject, ms.posterTime AS firstPosterTime, ms.ID_TOPIC, t.ID_BOARD, b.name AS bname, t.pretty_url,
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
		$topic_ids[] = $row['ID_TOPIC'];
]]></search>
			<add><![CDATA[
		$topic_ids[] = $row['ID_TOPIC'];

		$pretty_board = $modSettings['pretty_root_url'] . '/' . (isset($context['pretty']['board_urls'][$row['ID_BOARD']]) ? $context['pretty']['board_urls'][$row['ID_BOARD']] : $row['ID_BOARD']) . '/';
		$pretty_topic = $pretty_board . (isset($row['pretty_url']) && $row['pretty_url'] != '' ? $row['pretty_url'] : $row['ID_TOPIC']) . '/';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				$tmppages[] = '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.' . $tmpb . ';topicseen">' . $tmpa . '</a>';
]]></search>
			<add><![CDATA[
				$tmppages[] = '<a href="' . $pretty_topic . $tmpb . '/?topicseen">' . $tmpa . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				$pages .= ' &nbsp;<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0;all">' . $txt[190] . '</a>';
]]></search>
			<add><![CDATA[
				$pages .= ' &nbsp;<a href="' . $pretty_topic . '0/?all">' . $txt[190] . '</a>';
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0;topicseen',
				'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . '.0;topicseen">' . $row['firstSubject'] . '</a>'
]]></search>
			<add><![CDATA[
				'href' => $pretty_topic . '0/?topicseen',
				'link' => '<a href="' . $pretty_topic . '0/?topicseen">' . $row['firstSubject'] . '</a>'
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['ID_LAST_MSG']) . ';topicseen#msg' . $row['ID_LAST_MSG'],
				'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['ID_LAST_MSG']) . ';topicseen#msg' . $row['ID_LAST_MSG'] . '">' . $row['lastSubject'] . '</a>'
			),
			'new_from' => $row['new_from'],
			'new_href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . '.msg' . $row['new_from'] . ';topicseen#new',
			'href' => $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['new_from']) . ';topicseen' . ($row['numReplies'] == 0 ? '' : 'new'),
			'link' => '<a href="' . $scripturl . '?topic=' . $row['ID_TOPIC'] . ($row['numReplies'] == 0 ? '.0' : '.msg' . $row['new_from']) . ';topicseen#msg' . $row['new_from'] . '">' . $row['firstSubject'] . '</a>',
]]></search>
			<add><![CDATA[
				'href' => $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['ID_LAST_MSG']) . '/?topicseen#msg' . $row['ID_LAST_MSG'],
				'link' => '<a href="' . $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['ID_LAST_MSG']) . '/?topicseen#msg' . $row['ID_LAST_MSG'] . '">' . $row['lastSubject'] . '</a>'
			),
			'new_from' => $row['new_from'],
			'new_href' => $pretty_topic . 'msg' . $row['new_from'] . '/?topicseen#new',
			'href' => $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['new_from']) . '/?topicseen' . ($row['numReplies'] == 0 ? '' : 'new'),
			'link' => '<a href="' . $pretty_topic . ($row['numReplies'] == 0 ? '0' : 'msg' . $row['new_from']) . '/?topicseen#msg' . $row['new_from'] . '">' . $row['firstSubject'] . '</a>',
]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[
				'href' => $scripturl . '?board=' . $row['ID_BOARD'] . '.0',
				'link' => '<a href="' . $scripturl . '?board=' . $row['ID_BOARD'] . '.0">' . $row['bname'] . '</a>'
			)
]]></search>
			<add><![CDATA[
				'href' => $pretty_board . '0/',
				'link' => '<a href="' . $pretty_board . '0/">' . $row['bname'] . '</a>'
			)
]]></add>
		</operation>
	</file>

</modification>
